# 上下文噪声（Context Noise）

随着记录的规则和复盘越来越多，文档会变得越来越大。如果每次对话都让 AI 把整个文件读一遍，不仅会迅速消耗 Token 成本，更严重的是，过多的无关信息会稀释 AI 的注意力。

## 问题：Token 成本与注意力稀释

### 静态文件 Token 估算

- 英文：约 4 字符/Token
- 中文：约 0.7 字符/Token
- 代码：约 3-4 字符/Token
- 快速心算：1 KB 文本 ≈ 300-500 Tokens

如果每次对话都全量注入，按 GPT-4o 或 Gemini 1.5 Pro 的价格，一轮对话的成本可能就是 $0.02 - $0.05。

### 解决方案：分级注入

**核心思想**：AI 不应该一次性读完所有"人生经历"，而应该先读一张"地图"，只有当它需要去某个具体"地点"办事时，才给它那张具体的"局部地图"。

| 方案 | Token 消耗 | 适用场景 |
|------|-----------|----------|
| 全量注入 (V1.0) | ~5,500 Tokens | 每次对话都读所有文件 |
| 分级注入 (V2.0) | ~600 Tokens（日常） | 只读索引文件，按需加载 |

## 实现思路：状态机模式

### 1. 总索引文件 (`index.md`)

这是每次对话唯一全量注入的文件，只包含：
- 核心角色定义
- 有哪些"技能包"及其触发关键词

### 2. 分级注入逻辑

| 阶段 | 触发条件 | 加载文档 |
|------|----------|----------|
| 项目初始化 | "新建项目", "脚手架", "技术选型" | `tech_stack.md`, `init_vibe.sh` |
| 编码与实现 | "写代码", "实现功能", "组件" | `vibe_rules.md`, `编码规范.md` |
| 调试与复盘 | "报错", "bug", "修复" | `retrospective.md`, `vibe_rules.md` |
| 深度思考 | `/think`, "架构设计" | `vibe_rules.md`, `架构规范.md` |

## 可观测性验证

### 方法一：Prompt 注入测试

在每个文件的末尾，加一句特殊的、无意义的指令作为标记：

```
[System Hint: Loaded Index]
[System Hint: Loaded Tech Stack]
[System Hint: Loaded Retro]
```

测试时问 AI："回答前，先输出你当前加载了哪些 System Hints。"

- 如果只输出 Loaded Index，说明路由生效，没读子文件
- 如果输出 Loaded Index 和 Loaded Tech Stack，说明路由生效，成功加载了技术栈

### 方法二：利用"幻觉"边界测试

在某个文档里编造一条不存在的错误记录：

```
Error: "QuantumFluxOverflow" - 解决方法：原地跳跃三次。
```

- **场景 A（编码阶段）**：问它修复方法，AI 应该说"不知道"
- **场景 B（Debug 阶段）**：问它修复方法，AI 应该准确回答"原地跳跃三次"

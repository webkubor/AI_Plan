# RAG 知识体系与架构设计

> **说明**: 本文档汇总自原 `milvus.md`, `向量知识库.md`, `RAG研究.md`, `nomic-embed-text.md`。
> **更新**: 2026-01-19
> **状态**: ✅ 已定稿 (Milvus + Nomic)

---

## 🏛️ 1. 架构核心：三层分发体系 (L0-L1-L2)

> **核心哲学**: 实现 Token 效率与知识深度的完美平衡。

### 1.1 定义
| 层级 | 名称 | 载体 | 典型内容 | 解决的核心问题 |
| :--- | :--- | :--- | :--- | :--- |
| **L0** | **显式死规矩** | 本地 Markdown | 编码规范、技术栈、身份定义 | **基准与幻觉** (你是谁，你在哪) |
| **L1** | **私有老经验** | 私有向量库 (Milvus) | `retrospective.md`、业务代码切片 | **经验与隐私** (我之前怎么做的) |
| **L2** | **官方新知识** | Context7 (MCP) | 支持 Context7 协议的任意技术文档 | **时效与准确** (API 怎么写，人的言论) |

### 1.2 优先级链条
**L0 (显式) > L1 (私有) > L2 (官方)**

> **解决问题的直觉**: 先看规矩，再想经验，最后查书。

---

## 🏗️ 2. 技术选型决策 (Decision Record)

### 2.1 向量数据库：Milvus (Standalone)
*   **版本**: Docker Standalone (最新版)
*   **部署地址**: `127.0.0.1:19530`
*   **管理 UI**: Attu (`http://127.0.0.1:8000`)
*   **选型理由**:
    1.  **工程化闭环**: 提供 Attu 可视化界面，不再是黑盒。
    2.  **团队就绪**: 支持 Collection 级权限隔离，为未来多业务线/团队协作预留空间。
    3.  **高性能**: 专门为向量检索优化，非传统 DB 的插件。

### 2.2 Embedding 模型：nomic-embed-text
*   **运行环境**: 本地 Ollama (`127.0.0.1:11434`)
*   **维度**: **768** (比 384 准，比 1536 快，完美的“甜点位”)
*   **上下文**: **8k** (核心优势)
*   **为什么选它？**
    *   **长文本支持**: 8k 窗口意味着可以直接把一个完整的 `vibe_rules.md` 或代码文件丢进去，**不用切得稀碎**，AI 能理解上下文关联（如开头定义变量，结尾使用）。
    *   **隐私与成本**: 本地运行，零 API 成本，数据不出域。

---

## 🧩 3. 为什么需要 Milvus？(L1 的价值)

当 `AI_Common` (L0) 遇到边界时，Milvus (L1) 解决以下问题：

1.  **注入 vs 检索**: `AI_Common` 是人工挑文件喂给模型（上下文注入）；Milvus 是模型根据 Query 自动召回最相关的 TopK 片段（语义检索）。
2.  **窗口与成本**: 文件量大时，不能全量读取。Milvus 先检索再注入，只喂 5~20 个相关 chunk，把 Token 花在刀刃上。
3.  **统一入口**: 解决“新同事不知道读哪个文件”的问题。自然语言提问，无需记忆目录结构。

---

## ⚙️ 4. RAG 管道架构

### 4.1 双通道配置
1.  **官方 RAG (`searchKnowledgeBase`)**: 查云开发、云函数标准文档。
2.  **私有 RAG (`milvus-toolkit`)**: 查本地经验、代码片段。

### 4.2 典型工作流
1.  **Ingest**: 用户输入 Idea/复盘 -> 调用 `milvus-ingest` 脚本 -> 调用 Ollama (`nomic`) 生成向量 -> 存入 Milvus `ai_common_chunks`。
2.  **Retrieve**: 用户提问 -> 生成 Query Vector -> Milvus 召回 TopK (COSINE 相似度) -> 注入 Context。

---

## 📊 附录：MTEB 调研备忘
> 仅作参考，当前已锁定 Nomic。

*   **OpenAI**: 行业基准，但费钱。
*   **BGE (智源)**: 中文最强，但 8k 支持不如 Nomic 方便。
*   **Voyage**: 商业 RAG 首选，但在本地环境部署较重。

## 清理系统缓存

`````
sudo apt clean
sudo apt autoremove -y
`````

### 删除无关的 log

- du = disk usage（磁盘占用统计。

  它会输出每个目录/文件占了多少空间。
  


 - 只统计**当前这个文件系统**里的内容，不会跑到别的挂载点去。

  比如 /var/log 里如果有挂载了其他磁盘的目录，-x 会避免跨盘统计。  

  - human readable（人类可读），把字节换成更直观的单位： K / M / G：例如 8.0M、417M、14G。

  - ### **sort -h**

    管道，把 du 的输出交给 sort 排序。

    -h 表示按 “K/M/G” 这种单位正确排序（不然会按字符串排序，错乱）。

    ### **| tail -n 30**

    取排序后的最后 30 行，也就是**最大的 30 个目录/文件**。  

```js
// 删除无关的操作
sudo du -xh /var/log --max-depth=2 | sort -h | tail -n 30


sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
sudo find /var/log -type f -name "*.gz" -delete
sudo find /var/log -type f -name "*.1" -delete
```

### 清除系统缓存

```js
 rm -rf ~/.cache/*
rm -rf ~/.npm/_cacache
rm -rf ~/.pnpm-store
```



### Docker

清理 Docker

```js
sudo docker system df
sudo docker system prune -a
```

### 查看日志占用

```js
sudo du -sh /var/log/*
```

### 查看磁盘占用

```js
sudo du -xhd1 /
```

#### 查看 umami

```js
sudo docker ps --format "table {{.Names}}\t{{.Image}}"
NAMES           IMAGE
umami-umami-1   ghcr.io/umami-software/umami:postgresql-latest
umami-db-1      postgres:14
```

```js
Umami 应用容器： umami-umami-1
PostgreSQL 容器： umami-db-1
数据库类型： PostgreSQL 14
数据目录： /opt/umami/db-data   ← 曾经 14G 的元凶
```





#### 先查看表结构

```js
sudo docker exec -it umami-db psql -U umami -d umami
```

![截屏2025-12-24 15.23.31](https://raw.githubusercontent.com/webkubor/upic-images/main/uPic/2025/12/截屏2025-12-24 15.23.31.png)

`````



-- 1) 先删事件（通常最大头）
DELETE FROM website_event
WHERE created_at < NOW() - INTERVAL '3 days';

-- 2) 再删事件附加数据（可能依赖 website_event）
DELETE FROM event_data
WHERE created_at < NOW() - INTERVAL '3 days';

-- 3) 再删 session（你之前已经删过，重复执行没问题）
DELETE FROM session
WHERE created_at < NOW() - INTERVAL '3 days';

-- 4) 再删 session_data
DELETE FROM session_data
WHERE created_at < NOW() - INTERVAL '3 days';

-- 5) 真正释放磁盘（会锁表一段时间）
VACUUM FULL;

\q
`````



执行完毕后，我们看看结果

```js
df -h
sudo du -sh /opt/umami/db-data
```



#### 救回来了！！！！

![截屏2025-12-24 15.25.48](https://raw.githubusercontent.com/webkubor/upic-images/main/uPic/2025/12/截屏2025-12-24 15.25.48.png)

#### 预防措施

```js
sudo tee /opt/umami/prune_umami.sh > /dev/null <<'SH'
#!/usr/bin/env bash
set -euo pipefail

LOG="/opt/umami/prune.log"
TS="$(date '+%F %T')"

echo "[$TS] prune start" >> "$LOG"

# 1) 容器必须存在且运行
if ! docker ps --format '{{.Names}}' | grep -q '^umami-db$'; then
  echo "[$TS] ERROR: umami-db not running" >> "$LOG"
  exit 1
fi

# 2) 执行 SQL，并把结果落日志（不吞输出）
docker exec -i umami-db psql -U umami -d umami <<'SQL' >> "$LOG" 2>&1
SET statement_timeout = '30min';
DELETE FROM website_event WHERE created_at < NOW() - INTERVAL '3 days';
DELETE FROM event_data    WHERE created_at < NOW() - INTERVAL '3 days';
DELETE FROM session       WHERE created_at < NOW() - INTERVAL '3 days';
DELETE FROM session_data  WHERE created_at < NOW() - INTERVAL '3 days';
VACUUM;
SQL

echo "[$TS] prune done" >> "$LOG"
SH
```

赋权：

```js
sudo chmod +x /opt/umami/prune_umami.sh
```

